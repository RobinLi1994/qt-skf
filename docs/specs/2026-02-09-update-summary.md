# 文档更新摘要报告

> **更新日期**: 2026-02-09
> **更新类型**: 功能补充
> **影响范围**: spec.md, tasks.md

---

## 📋 更新概述

基于原项目（ts-wekey-skf）功能对比分析，补充了当前 C++/Qt 重构项目中缺失的文件管理功能，以及完善了部分参数定义，确保与原项目功能完全对等。

---

## 📝 文档变更详情

### 1. `spec.md` 更新

#### 1.1 新增 §5.3.7 文件管理页

**位置**: 在 §5.3.6 日志查看页之后

**新增内容**:
- 文件管理页面规格说明
- 界面布局（设备选择器 + 应用选择器 + 文件列表）
- 创建文件对话框规格
  - 文件名输入
  - 文件选择（QFileDialog）
  - 读/写权限配置
  - 8KB 文件大小限制提示

**功能点**:
- ✅ 枚举文件列表
- ✅ 创建/上传文件到设备
- ✅ 读取/下载文件到本地
- ✅ 删除文件（二次确认）

---

#### 1.2 补充 §3.1.2 应用管理参数

**新增参数说明**:

**createApp 参数（args）**:
- `adminPin` (QString): 管理员 PIN 码
- `userPin` (QString): 用户 PIN 码
- `adminPinRetryCount` (int, 可选): 管理员 PIN 重试次数，默认 6 ⭐ **新增**
- `userPinRetryCount` (int, 可选): 用户 PIN 重试次数，默认 6 ⭐ **新增**
- `createFileRights` (int, 可选): 创建文件权限，默认 0

**loginApp 参数（args）**:
- `pin` (QString): PIN 码
- `role` (QString): 角色，"admin" 或 "user"

**updateAppPin 参数（args）**:
- `role` (QString): 角色
- `oldPin` (QString): 原 PIN 码
- `newPin` (QString): 新 PIN 码

**unblockApp 参数（args）**:
- `adminPin` (QString): 管理员 PIN 码
- `newUserPin` (QString): 新的用户 PIN 码

---

#### 1.3 补充 §3.1.4 证书操作参数

**新增参数说明**:

**generateCsr 参数（args）**:
- `keyPairType` (QString): 密钥对类型（SM2/RSA-2048/3072/4096）
- `cname` (QString): 通用名
- `org` (QString): 组织
- `unit` (QString): 部门
- `renew` (bool, 可选): 是否重新生成密钥对，默认 false
- `isNonGMCert` (bool, 可选): 是否为非国密证书，默认 false ⭐ **新增**
  - 设置为 true 时，使用标准 X.509 格式而非国密格式
  - 仅在密钥类型为 RSA 时有效

**importCertificate 参数（args）**:
- `cert` (QString): 证书 PEM 格式字符串
- `certChain` (QStringList, 可选): 证书链
- `signFlag` (bool, 可选): 是否为签名证书，默认 true

---

#### 1.4 更新 §5.2 窗口结构

**变更**:
在左侧导航中，在"容器管理"和"配置管理"之间新增：
- **文件管理** ⭐ **新增**

**更新后的导航顺序**:
1. 模块管理
2. 设备管理
3. 应用管理
4. 容器管理
5. **文件管理** ⬅️ 新增
6. 配置管理
7. （分隔线）
8. 日志查看

---

### 2. `tasks.md` 更新

#### 2.1 新增 M5.11 文件管理页任务

**插入位置**: M5.10（对话框）和原 M5.11（页面集成）之间

**新增任务**:

| 任务 ID | 类型 | 任务描述 | 文件 |
|---------|------|----------|------|
| M5.11.1T | 测试 | 编写 FilePage 单元测试 | `tests/unit/test_filepage.cpp` |
| M5.11.2I | 实现 | 实现 FilePage.h | `src/gui/pages/FilePage.h` |
| M5.11.3I | 实现 | 实现 FilePage.cpp | `src/gui/pages/FilePage.cpp` |
| M5.11.4I | 实现 | 实现文件创建对话框 | `src/gui/dialogs/CreateFileDialog.h/cpp` |

**详细说明**:
- 测试用例覆盖：页面构造、设备/应用选择器、文件表格、刷新功能
- 实现功能：枚举文件、创建文件、读取文件、删除文件
- 对话框功能：文件名输入、文件选择、权限配置、大小验证（8KB 限制）

---

#### 2.2 调整原有任务编号

**章节编号变更**:
- 原 `M5.11 页面集成` → **M5.12 页面集成**
- 原 `M5.12 验收检查点` → **M5.13 验收检查点**

**依赖关系调整**:
- M5.12.1I（页面集成）依赖增加：`M5.11.4I`（文件管理页）
- M6.1.2T（端到端测试）依赖更新：`M5.12.2` → `M5.13.2`

---

#### 2.3 更新任务统计

**M5 里程碑**:
- 配置任务：5 个（不变）
- 测试任务：13 → **14 个** (+1)
- 实现任务：22 → **25 个** (+3)
- 总计：40 → **44 个** (+4)

**项目总计**:
- 配置任务：32 个（不变）
- 测试任务：56 → **57 个** (+1)
- 实现任务：95 → **98 个** (+3)
- 总任务数：183 → **187 个** (+4)

---

## 🎯 功能完整性对比

### 原项目已有 vs 当前项目

| 功能模块 | 原项目 | 更新前 | 更新后 |
|----------|--------|--------|--------|
| 模块管理 | ✅ | ✅ | ✅ |
| 设备管理 | ✅ | ✅ | ✅ |
| 应用管理 | ✅ | ✅ | ✅ |
| 容器管理 | ✅ | ✅ | ✅ |
| **文件管理** | ✅ | ❌ | ✅ ⬅️ **已补充** |
| 配置管理 | ✅ | ✅ | ✅ |
| 日志查看 | ❌ | ✅ | ✅ |

### 参数完整性对比

| 参数 | 原项目 | 更新前 | 更新后 |
|------|--------|--------|--------|
| createApp - adminPinRetryCount | ✅ | ❌ | ✅ ⬅️ **已补充** |
| createApp - userPinRetryCount | ✅ | ❌ | ✅ ⬅️ **已补充** |
| generateCsr - isNonGMCert | ✅ | ❌ | ✅ ⬅️ **已补充** |

---

## ✅ 验收标准

### 文档完整性
- [x] spec.md 包含文件管理页完整规格
- [x] spec.md 补充所有参数说明
- [x] tasks.md 新增文件管理任务（4 个）
- [x] tasks.md 任务编号调整正确
- [x] tasks.md 统计数据准确

### 功能覆盖
- [x] 文件管理 GUI 规格定义完整
- [x] 应用创建参数包含重试次数配置
- [x] CSR 生成参数包含非国密证书支持

---

## 📊 影响分析

### 开发工作量

**新增实现工作**:
- FilePage 页面实现（约 300 行代码）
- CreateFileDialog 对话框实现（约 200 行代码）
- 单元测试（约 150 行代码）
- **估算工时**: 2-3 人天

**现有代码修改**:
- MainWindow 添加 FilePage 导航项（约 10 行）
- AppPage/CsrDialog 补充参数输入字段（约 50 行）
- **估算工时**: 0.5 人天

**总估算**: **2.5-3.5 人天**

---

### 测试工作量

**新增测试**:
- FilePage 单元测试（6 个测试用例）
- CreateFileDialog 单元测试（4 个测试用例）
- 文件管理集成测试（1 个端到端测试场景）

**回归测试**:
- 应用创建流程（验证新参数）
- CSR 生成流程（验证非国密选项）

**估算工时**: **1-1.5 人天**

---

## 🔄 后续行动项

### 立即执行（本周）

1. **代码实现** (P0)
   - [ ] 实现 FilePage 页面
   - [ ] 实现 CreateFileDialog 对话框
   - [ ] 补充 AppPage 创建对话框参数
   - [ ] 补充 CsrDialog 非国密证书选项

2. **测试验证** (P0)
   - [ ] 编写单元测试
   - [ ] 执行集成测试
   - [ ] 验证参数传递正确性

3. **文档同步** (P1)
   - [ ] 更新 API 文档（如有）
   - [ ] 更新用户手册（如有）

---

### 后续优化（可选）

1. **用户体验优化**
   - 文件上传进度条
   - 文件类型图标显示
   - 批量文件操作

2. **错误处理增强**
   - 文件大小超限友好提示
   - 权限不足错误说明
   - 设备断开时的状态恢复

---

## 📎 相关文档

- [GUI 功能对比分析](./gui-comparison.md)
- [产品规格说明书](../spec.md)
- [任务列表](../tasks.md)

---

**变更审批**: 待产品负责人确认
**实施负责人**: 开发团队
**预计完成时间**: 2026-02-16

---

**文档结束**
