# wekey-skf GUI 功能对比与补充需求分析

> **文档版本**: 1.0.0
> **创建日期**: 2026-02-09
> **作者**: Claude Code
> **状态**: 待评审

---

## 1. 文档目的

本文档对比原 Go 项目 (`ts-wekey-skf`) 和当前 C++/Qt 重构项目 (`wekey-skf`) 的 GUI 页面层级与功能需求，识别可能遗漏的功能点，确保功能完整性。

---

## 2. 项目架构对比

### 2.1 原项目 (ts-wekey-skf)

**技术栈**: Go (Wails) + React + TypeScript + Ant Design

**页面导航方式**: 嵌套路由（多层级）

```
路由结构:
├── / (LoadingScreen - 初始加载)
├── /mod (ModManager - 模块管理)
├── /device (DeviceManager - 设备列表)
│   └── /device/:serialNumber (DeviceApp - 应用列表)
│       └── /device/:serialNumber/:appName (DeviceAppDetail - 应用详情)
│           ├── 容器管理 Tab (ContainerManagement)
│           └── 文件管理 Tab (FileManagement)
└── /config (ConfigManager - 配置管理)
```

### 2.2 当前项目 (wekey-skf)

**技术栈**: C++ + Qt 6.10.2 Widgets

**页面导航方式**: 左侧导航 + 右侧页面栈（单层级）

```
窗口结构:
MainWindow
├── 左侧导航
│   ├── 模块管理
│   ├── 设备管理
│   ├── 应用管理
│   ├── 容器管理
│   ├── 配置管理
│   └── 日志查看
└── 右侧内容区 (QStackedWidget)
    ├── ModulePage
    ├── DevicePage
    ├── AppPage
    ├── ContainerPage
    ├── ConfigPage
    └── LogPage
```

**关键差异**:
1. **导航模式**:
   - 原项目：路由驱动，面包屑导航，支持前进/后退
   - 当前项目：侧边栏 + 页面栈，平级切换

2. **数据流转**:
   - 原项目：通过 URL 参数传递设备/应用/容器上下文
   - 当前项目：通过下拉选择框（设备选择器 + 应用选择器）

---

## 3. 功能对比矩阵

### 3.1 模块管理

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 列出已注册模块 | ✅ | ✅ | 已实现 |
| 添加新模块 (.dll/.dylib) | ✅ | ✅ | 已实现 |
| 删除模块 | ✅ | ✅ | 已实现 |
| 激活/切换模块 | ✅ | ✅ | 已实现 |
| 显示模块路径 | ✅ | ✅ | 已实现 |
| 显示模块状态（已激活/未激活） | ✅ | ✅ | 已实现 |

**结论**: ✅ 功能完整

---

### 3.2 设备管理

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 枚举设备列表 | ✅ | ✅ | 已实现 |
| 显示设备序列号 | ✅ | ✅ | 已实现 |
| 显示设备制造商 | ✅ | ✅ | 已实现 |
| 显示硬件版本 | ✅ | ✅ | 已实现 |
| 显示固件版本 | ✅ | ✅ | 已实现 |
| 显示登录状态 (徽章) | ✅ | ✅ | 已实现 |
| 编辑设备标签/名称 | ✅ | ✅ | 已实现 |
| 修改设备认证密钥 | ⚠️ | ✅ (在 spec.md 中定义) | 需验证实现 |
| 点击序列号跳转到应用列表 | ✅ (路由跳转) | ⚠️ | **差异** |
| 刷新设备列表按钮 | ✅ | ✅ | 已实现 |
| 设备详情展示区 | ✅ | ✅ | 已实现 |

**关键差异**:
- 原项目：点击序列号 → 路由跳转到 `/device/:serialNumber`
- 当前项目：在应用管理页通过下拉框选择设备

**建议**: 当前设计合理，无需调整。

---

### 3.3 应用管理

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 枚举应用列表 | ✅ | ✅ | 已实现 |
| 创建应用 | ✅ | ✅ | 已实现 |
| 删除应用 | ✅ | ✅ | 已实现 |
| 登录应用 (弹窗) | ✅ | ✅ | 已实现 |
| 登出应用 | ✅ | ✅ | 已实现 |
| 修改 PIN 码 | ✅ | ✅ | 已实现 |
| 解锁 PIN (unblock) | ✅ | ✅ | 已实现 |
| 显示登录状态标签 | ✅ | ✅ | 已实现 |
| 显示剩余尝试次数 | ✅ | ✅ | 已实现 |
| 按设备筛选应用 | ✅ (URL 参数) | ✅ (下拉选择器) | **实现方式不同** |
| 点击应用名称跳转详情 | ✅ (路由) | ⚠️ | **差异** |

**创建应用表单字段对比**:

| 字段 | 原项目 | 当前项目 spec.md | 备注 |
|------|--------|------------------|------|
| 应用名称 | ✅ | ✅ | - |
| 管理员 PIN | ✅ | ✅ | - |
| 管理员重试次数 | ✅ | ⚠️ | **可能遗漏** |
| 用户 PIN | ✅ | ✅ | - |
| 用户重试次数 | ✅ | ⚠️ | **可能遗漏** |

**⚠️ 重要发现**: 原项目在创建应用时可配置 PIN 重试次数，当前 spec.md 未明确提及。

---

### 3.4 容器管理

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 枚举容器列表 | ✅ | ✅ | 已实现 |
| 创建容器 | ✅ | ✅ | 已实现 |
| 删除容器 | ✅ | ✅ | 已实现 |
| 显示密钥类型 | ✅ | ✅ | 已实现 |
| 显示密钥生成状态 | ✅ | ✅ | 已实现 |
| 显示证书导入状态 | ✅ | ✅ | 已实现 |
| 生成 CSR | ✅ | ✅ | 已实现 |
| 导入证书 | ✅ | ✅ | 已实现 |
| 导出证书 | ✅ | ✅ | 已实现 |
| 验证证书 | ✅ | ✅ | 已实现 |
| 按设备+应用筛选 | ✅ | ✅ | 已实现 |

**生成 CSR 表单字段对比**:

| 字段 | 原项目 | 当前项目 spec.md | 备注 |
|------|--------|------------------|------|
| 密钥类型选择 | ✅ (SM2/RSA) | ✅ | - |
| RSA 密钥长度 | ✅ (2048/3072/4096) | ✅ | - |
| 通用名 (CN) | ✅ | ✅ | - |
| 组织 (O) | ✅ | ✅ | - |
| 部门 (OU) | ✅ | ✅ | - |
| 重新生成密钥对 (Renew) | ✅ | ✅ | - |
| 非国密证书开关 | ✅ | ❌ | **遗漏** |

**⚠️ 重要发现**: 原项目支持"非国密证书"模式切换，当前项目未包含。

**导入证书功能对比**:

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 导入单个证书 | ✅ | ✅ | 已实现 |
| 导入证书链 | ✅ | ✅ | 已实现 |
| 文件选择器 | ✅ (Wails 原生对话框) | ✅ (Qt QFileDialog) | 已实现 |
| 证书预览/解析 | ✅ | ⚠️ | 需确认 |

---

### 3.5 文件管理

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 枚举文件列表 | ✅ | ❌ | **🚨 功能缺失** |
| 创建文件 | ✅ | ❌ | **🚨 功能缺失** |
| 读取文件 | ✅ | ❌ | **🚨 功能缺失** |
| 删除文件 | ✅ | ❌ | **🚨 功能缺失** |
| 文件大小限制 (8KB) | ✅ | ❌ | **🚨 功能缺失** |
| 文件权限配置 | ✅ | ❌ | **🚨 功能缺失** |

**原项目文件管理位置**: `/device/:serialNumber/:appName` 页面下的"文件管理" Tab

**当前项目状态**:
- ❌ spec.md 未定义文件管理页面
- ❌ tasks.md 中未包含文件管理相关任务
- ❌ IDriverPlugin 接口包含文件操作方法，但无对应 GUI

**🚨 重大遗漏**: 文件管理模块完全缺失！

---

### 3.6 配置管理

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 默认应用名 | ✅ | ✅ | 已实现 |
| 默认角色 | ✅ | ✅ | 已实现 |
| 默认容器名 | ✅ | ✅ | 已实现 |
| 默认通用名 | ✅ | ✅ | 已实现 |
| 默认组织 | ✅ | ✅ | 已实现 |
| 默认部门 | ✅ | ✅ | 已实现 |
| 随机数长度 | ✅ | ⚠️ | 需确认 |
| 日志级别 | ✅ | ✅ | 已实现 |
| HTTP 端口 | ✅ (只读) | ✅ | 已实现 |
| 版本号显示 | ✅ (只读) | ⚠️ | 需确认 |
| 错误提示模式 | ❌ | ✅ | **当前项目新增** |
| 系统托盘开关 | ❌ | ✅ | **当前项目新增** |
| 保存/恢复默认按钮 | ✅ | ✅ | 已实现 |

**结论**: 功能大致对等，当前项目新增了错误提示模式切换。

---

### 3.7 日志查看

| 功能点 | 原项目 | 当前项目 | 状态 |
|--------|--------|----------|------|
| 实时日志显示 | ❌ | ✅ | **当前项目新增** |
| 按级别过滤 | ❌ | ✅ | **当前项目新增** |
| 文本搜索 | ❌ | ✅ | **当前项目新增** |
| 清空日志 | ❌ | ✅ | **当前项目新增** |

**原项目日志方案**: 仅写入文件，无 GUI 查看功能。

**当前项目优势**: 提供实时日志查看，方便调试。

---

## 4. 关键功能遗漏汇总

### 4.1 完全缺失的模块

#### 🚨 **文件管理功能** (高优先级)

**位置建议**:
- 方案 1: 在 ContainerPage 中新增"文件管理" Tab（对齐原项目）
- 方案 2: 新增独立的 FilePage 页面

**必需功能**:
1. 枚举文件列表 (IDriverPlugin::enumFiles)
2. 创建文件 (IDriverPlugin::createFile)
   - 文件名输入
   - 文件上传 (QFileDialog)
   - 文件大小限制 (8KB)
   - 读权限配置
   - 写权限配置
3. 读取文件 (IDriverPlugin::readFile) - 下载到本地
4. 删除文件 (IDriverPlugin::deleteFile)

**界面草图**:
```
┌─────────────────────────────────────────────────────────┐
│ 文件管理                                    [+ 创建文件] │
├─────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────┐ │
│ │ 文件名              大小        操作                 │ │
│ ├─────────────────────────────────────────────────────┤ │
│ │ config.dat          1.2 KB      [读取][删除]        │ │
│ │ userdata.bin        5.8 KB      [读取][删除]        │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

### 4.2 部分功能缺失

#### ⚠️ **应用创建参数不完整**

**缺失字段**:
- 管理员 PIN 重试次数 (adminRetry)
- 用户 PIN 重试次数 (userRetry)

**原项目实现**:
```typescript
createApp(serialNumber, {
  name: values.name,
  adminPIN: values.adminPIN,
  adminRetry: values.adminRetry,  // ← 当前项目缺失
  userPIN: values.userPIN,
  userRetry: values.userRetry,     // ← 当前项目缺失
});
```

**建议**:
在 `spec.md` 和 `IDriverPlugin::createApp` 的 `args` 参数中补充：
- `adminPinRetryCount: int` (默认 6)
- `userPinRetryCount: int` (默认 6)

---

#### ⚠️ **容器管理 - 非国密证书支持**

**原项目功能**:
- CSR 生成对话框有"非国密证书"开关 (`isNonGMCert`)
- 影响密钥生成和证书格式

**当前项目状态**:
- spec.md 未提及
- CsrDialog 设计中无此选项

**建议**:
- 如果产品定位仅支持国密，可忽略
- 如需兼容 RSA 等非国密算法，需补充此开关

---

#### ⚠️ **配置项遗漏**

| 配置项 | 原项目 | 当前项目 |
|--------|--------|----------|
| 随机数长度 (`randomLength`) | ✅ | ⚠️ 需确认 |

---

## 5. UI/UX 差异对比

### 5.1 导航模式

| 维度 | 原项目 | 当前项目 |
|------|--------|----------|
| 导航方式 | 路由 + 面包屑 | 侧边栏 + 页面栈 |
| 前进/后退 | ✅ 支持 | ❌ 不适用 |
| 上下文传递 | URL 参数 | 下拉选择器 |
| 深度层级 | 4 层 (设备→应用→容器) | 1 层 (平级页面) |

**评价**:
- 原项目更适合 Web 应用习惯（浏览器历史记录）
- 当前项目更符合桌面应用习惯（单窗口操作）
- 两种设计均合理，无优劣之分

---

### 5.2 设备/应用/容器选择

| 场景 | 原项目 | 当前项目 |
|------|--------|----------|
| 查看设备应用 | 点击设备序列号跳转 | 应用页选择设备 |
| 查看应用容器 | 点击应用名称跳转 | 容器页选择设备+应用 |
| 切换上下文 | 点击面包屑 | 切换下拉选择器 |

**评价**:
- 原项目：层级清晰，适合"深入探索"
- 当前项目：快速切换，适合"并行操作"

---

### 5.3 对话框与表单

| 功能 | 原项目 | 当前项目 |
|------|--------|----------|
| 登录对话框 | Ant Design Modal | Qt QDialog |
| CSR 生成对话框 | Ant Design Modal | Qt QDialog |
| 导入证书对话框 | Ant Design Modal | Qt QDialog |
| 文件选择器 | Wails 原生对话框 | Qt QFileDialog |

**评价**: 技术栈差异，功能对等。

---

## 6. 数据结构对比

### 6.1 CreateApp 参数

**原项目 (TypeScript)**:
```typescript
interface CreateAppParams {
  name: string;
  adminPIN: string;
  adminRetry: number;  // ← 新发现
  userPIN: string;
  userRetry: number;   // ← 新发现
}
```

**当前项目 (C++ spec.md)**:
```cpp
createApp(devName, appName, args: {
  "adminPin": QString,
  "userPin": QString
  // adminRetry 和 userRetry 缺失
})
```

---

### 6.2 GenerateCsr 参数

**原项目 (TypeScript)**:
```typescript
interface CsrParams {
  keyType: "SM2" | "RSA";
  keySize?: number;        // RSA 时有效
  cname: string;
  org: string;
  unit: string;
  renewKey: boolean;
  isNonGMCert?: boolean;   // ← 新发现
}
```

**当前项目 (C++ spec.md)**:
```cpp
generateCsr(devName, appName, containerName, args: {
  "keyPairType": "SM2_sm2p256v1" | "RSA_2048" | "RSA_3072" | "RSA_4096",
  "cname": QString,
  "org": QString,
  "unit": QString
  // renewKey 和 isNonGMCert 未明确
})
```

---

## 7. 建议补充的任务

### 7.1 高优先级 (P0)

#### **M5.X: 文件管理功能**

| 任务 ID | 任务描述 | 文件 |
|---------|----------|------|
| M5.X.1T | 编写 FilePage 单元测试 | `tests/unit/test_filepage.cpp` |
| M5.X.2I | 实现 FilePage.h | `src/gui/pages/FilePage.h` |
| M5.X.3I | 实现 FilePage.cpp | `src/gui/pages/FilePage.cpp` |
| M5.X.4I | 添加到 MainWindow 导航 | `src/gui/MainWindow.cpp` |

或者，如果选择集成到 ContainerPage：

| 任务 ID | 任务描述 | 文件 |
|---------|----------|------|
| M5.X.1T | 编写 FileManagementWidget 测试 | `tests/unit/test_filewidget.cpp` |
| M5.X.2I | 实现 FileManagementWidget.h | `src/gui/widgets/FileManagementWidget.h` |
| M5.X.3I | 实现 FileManagementWidget.cpp | `src/gui/widgets/FileManagementWidget.cpp` |
| M5.X.4I | 添加 Tab 到 ContainerPage | `src/gui/pages/ContainerPage.cpp` |

---

### 7.2 中优先级 (P1)

#### **补充应用创建参数**

| 任务 ID | 任务描述 | 影响范围 |
|---------|----------|----------|
| SPEC-1 | 更新 spec.md §3.1.2 createApp 参数 | `spec.md` |
| SPEC-2 | 更新 IDriverPlugin 接口文档注释 | `src/plugin/interface/IDriverPlugin.h` |
| IMPL-1 | AppPage 创建对话框增加重试次数输入框 | `src/gui/pages/AppPage.cpp` |
| IMPL-2 | SkfPlugin 实现中传递 adminRetry/userRetry | `src/plugin/skf/SkfPlugin.cpp` |

---

#### **补充 CSR 生成参数**

| 任务 ID | 任务描述 | 影响范围 |
|---------|----------|----------|
| SPEC-3 | 确认是否支持非国密证书 | 产品需求 |
| SPEC-4 | 若支持，更新 spec.md §3.1.4 | `spec.md` |
| IMPL-3 | CsrDialog 增加"非国密证书"开关 | `src/gui/dialogs/CsrDialog.cpp` |

---

### 7.3 低优先级 (P2)

#### **配置管理补充**

| 任务 ID | 任务描述 | 影响范围 |
|---------|----------|----------|
| SPEC-5 | 明确 randomLength 配置项 | `spec.md` |
| IMPL-4 | ConfigPage 增加随机数长度配置 | `src/gui/pages/ConfigPage.cpp` |

---

## 8. 技术债务与风险

### 8.1 文件管理功能缺失的风险

**影响**:
- 无法满足与原项目功能对等的要求
- 用户可能无法在设备上存储自定义配置文件
- SKF 规范中定义的文件操作无法通过 GUI 使用

**建议**: 作为 M5.X 或 M7（后续增强）补充。

---

### 8.2 参数完整性风险

**影响**:
- 创建应用时无法自定义 PIN 重试次数（默认值可能不符合用户需求）
- CSR 生成时缺少高级选项（非国密证书）

**建议**: 尽快补充 spec.md，避免后期大范围修改。

---

## 9. 推荐行动方案

### 9.1 立即行动 (本周)

1. **确认产品需求**:
   - 文件管理功能是否必需？
   - 非国密证书是否需要支持？
   - PIN 重试次数是否允许用户配置？

2. **更新规格文档**:
   - 补充 `spec.md` §3.1.2 (应用管理参数)
   - 补充 `spec.md` §3.1.4 (CSR 生成参数)
   - 新增 `spec.md` §5.3.7 (文件管理页)

3. **更新任务列表**:
   - 在 `tasks.md` 中新增 M5.X (文件管理) 或 M7 (后续增强)

---

### 9.2 短期规划 (2 周内)

1. **实现文件管理页面** (如果确认为必需功能)
2. **补充应用创建参数**
3. **补充 CSR 生成参数** (如果支持非国密)

---

### 9.3 长期优化 (可选)

1. **导航历史记录**: 考虑在桌面应用中模拟浏览器历史记录（前进/后退按钮）
2. **快捷键支持**: 为常用操作添加键盘快捷键
3. **批量操作**: 支持批量删除容器/文件等

---

## 10. 附录

### 10.1 原项目文件管理功能截图说明

**功能位置**: `/device/:serialNumber/:appName` → "文件管理" Tab

**主要操作**:
1. 列表展示文件名
2. 创建文件对话框:
   - 文件名输入
   - 文件上传 (本地文件选择)
   - 文件大小限制提示 (8KB)
   - 读权限下拉选择
   - 写权限下拉选择
3. 读取文件 (下载到本地)
4. 删除文件 (二次确认)

---

### 10.2 原项目 vs 当前项目页面映射表

| 原项目路由 | 原项目页面 | 当前项目页面 | 映射方式 |
|------------|------------|--------------|----------|
| `/mod` | ModManager | ModulePage | 1:1 对应 |
| `/device` | DeviceManager | DevicePage | 1:1 对应 |
| `/device/:serialNumber` | DeviceApp | AppPage | 路由参数 → 下拉选择器 |
| `/device/:serialNumber/:appName` (容器 Tab) | DeviceAppDetail → ContainerManagement | ContainerPage | 路由参数 → 下拉选择器 |
| `/device/:serialNumber/:appName` (文件 Tab) | DeviceAppDetail → FileManagement | ❌ 缺失 | **需新增** |
| `/config` | ConfigManager | ConfigPage | 1:1 对应 |
| N/A | N/A | LogPage | **新增功能** |

---

### 10.3 相关文档链接

- [产品规格说明书](../spec.md)
- [技术实现方案](../plan.md)
- [任务列表](../tasks.md)
- [IDriverPlugin 接口定义](../../src/plugin/interface/IDriverPlugin.h)

---

## 11. 结论

当前 C++/Qt 重构项目在核心功能上与原项目基本对等，但存在以下关键遗漏：

1. **🚨 文件管理功能完全缺失** (高优先级，需补充)
2. **⚠️ 应用创建参数不完整** (中优先级，建议补充)
3. **⚠️ CSR 生成参数缺少高级选项** (中优先级，视产品需求)

建议立即更新 `spec.md` 和 `tasks.md`，并在 M5 或 M6 阶段补充遗漏功能，确保功能完整性。

---

**文档结束**
